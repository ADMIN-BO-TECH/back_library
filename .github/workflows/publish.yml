name: Publish - GitHub Packages

on:
  push:
    branches: ["main"]

permissions:
  contents: read
  packages: write

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "maven"

      - name: Extract version from commit message
        id: ver
        shell: bash
        run: |
          MSG="$(git log -1 --pretty=%B)"
          echo "Commit message:"
          echo "$MSG"

          VERSION="$(echo "$MSG" | grep -Eo '(release:\s*[0-9]+\.[0-9]+\.[0-9]+|version=([0-9]+\.[0-9]+\.[0-9]+)|\[version:([0-9]+\.[0-9]+\.[0-9]+)\])' \
            | head -n 1 \
            | sed -E 's/release:\s*//; s/version=//; s/\[version://; s/\]//')"

          if [ -z "$VERSION" ]; then
            echo "No version found in commit message. Skipping publish."
            echo "publish=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Detected version: $VERSION"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "publish=true" >> "$GITHUB_OUTPUT"

      - name: Create Maven settings.xml for GitHub Packages (uses GITHUB_TOKEN)
        if: steps.ver.outputs.publish == 'true'
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml << EOF
          <settings>
            <servers>
              <server>
                <id>github</id>
                <username>${{ github.actor }}</username>
                <password>${{ secrets.GITHUB_TOKEN }}</password>
              </server>
            </servers>
          </settings>
          EOF

      - name: Set Maven project version
        if: steps.ver.outputs.publish == 'true'
        run: |
          mvn -B -s ~/.m2/settings.xml versions:set \
            -DnewVersion="${{ steps.ver.outputs.version }}" \
            -DgenerateBackupPoms=false

      - name: Build & Deploy
        if: steps.ver.outputs.publish == 'true'
        run: |
          mvn -B -s ~/.m2/settings.xml clean deploy -DskipTests
name: Publish - GitHub Packages

on:
  push:
    branches: ["main"]

permissions:
  contents: read
  packages: write

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Esto crea automÃ¡ticamente un settings.xml con el server-id "github"
      # y asocia username/password a los env vars indicados.
      - name: Set up JDK 17 + Maven server auth (GitHub Packages)
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "maven"
          server-id: github
          server-username: GH_USER
          server-password: GH_TOKEN

      - name: Extract version from commit message
        id: ver
        shell: bash
        run: |
          MSG="$(git log -1 --pretty=%B)"
          echo "Commit message:"
          echo "$MSG"

          # Formatos soportados:
          # - release: 0.1.9
          # - version=0.1.9
          # - [version:0.1.9]
          VERSION="$(echo "$MSG" | grep -Eo '(release:\s*[0-9]+\.[0-9]+\.[0-9]+|version=([0-9]+\.[0-9]+\.[0-9]+)|\[version:([0-9]+\.[0-9]+\.[0-9]+)\])' \
            | head -n 1 \
            | sed -E 's/release:\s*//; s/version=//; s/\[version://; s/\]//')"

          if [ -z "$VERSION" ]; then
            echo "No version found in commit message. Skipping publish."
            echo "publish=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Detected version: $VERSION"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "publish=true" >> "$GITHUB_OUTPUT"

      - name: Set Maven project version
        if: steps.ver.outputs.publish == 'true'
        run: |
          mvn -B versions:set \
            -DnewVersion="${{ steps.ver.outputs.version }}" \
            -DgenerateBackupPoms=false
        env:
          GH_USER: ${{ github.actor }}
          GH_TOKEN: ${{ secrets.GH_PACKAGES_TOKEN }}

      - name: Build & Deploy
        if: steps.ver.outputs.publish == 'true'
        run: |
          mvn -B clean deploy -DskipTests
        env:
          GH_USER: ${{ github.actor }}
          GH_TOKEN: ${{ secrets.GH_PACKAGES_TOKEN }}